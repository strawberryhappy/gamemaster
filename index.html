<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>OpenCV Matching</title>
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
</head>
<body>
    <div id="message">一致率: - %</div>
    <video id="video" width="500" height="685" autoplay></video>
    <canvas id="canvas" width="500" height="685" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const targetImage = new Image();
        targetImage.crossOrigin = "Anonymous";
        targetImage.src = 'citizen.png'; // 比較画像のパスを指定

        let videoStream;

        function onOpenCvReady() {
            console.log("OpenCV.js is ready.");
            startCamera(); // OpenCVの準備が整ったらカメラを開始
        }

        async function startCamera() {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = videoStream;
            video.play();
            requestAnimationFrame(processFrame);
        }

        async function processFrame() {
            if (video.paused || video.ended) return;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frameData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            const { keypoints: videoKeypoints, descriptors: videoDescriptors } = extractFeatures(frameData);
            const { keypoints: imageKeypoints, descriptors: imageDescriptors } = await extractImageFeatures(targetImage);

            const matches = matchFeatures(videoDescriptors, imageDescriptors);
            const matchRate = calculateMatchRate(matches, videoKeypoints.size());

            console.log(`一致率: ${matchRate.toFixed(2)}%`);
            document.getElementById("message").textContent = `<p>一致率: ${matchRate.toFixed(2)}%</p>`;

            requestAnimationFrame(processFrame);
        }

        function extractFeatures(image) {
            const src = cv.matFromImageData(image);
            const gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

            const orb = new cv.ORB();
            const keypoints = new cv.KeyPointVector();
            const descriptors = new cv.Mat();
            orb.detect(gray, keypoints);
            orb.compute(gray, keypoints, descriptors);

            src.delete();
            gray.delete();

            return { keypoints, descriptors };
        }

        async function extractImageFeatures(image) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.drawImage(image, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            return extractFeatures(imageData);
        }

        function matchFeatures(descriptors1, descriptors2) {
            const matcher = new cv.BFMatcher(cv.NORM_HAMMING, true);
            const matches = new cv.DMatchVector();
            matcher.match(descriptors1, descriptors2, matches);
            return matches;
        }

        function calculateMatchRate(matches, totalKeypoints) {
            return (matches.size() / totalKeypoints) * 100;
        }
    </script>
</body>
</html>
