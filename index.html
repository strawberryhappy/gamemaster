<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ヒストグラムによる画像一致判定</title>
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
</head>
<body>
    <div id="message">一致率: - %</div>
    <video id="video" width="500" height="685" autoplay></video>
    <canvas id="canvas" width="500" height="685" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const targetImage = new Image();
        targetImage.crossOrigin = "Anonymous";
        targetImage.src = 'citizen.png'; // 比較画像のパスを指定

        let videoStream;

        function onOpenCvReady() {
            console.log("OpenCV.js is ready.");
            startCamera();
        }

        async function startCamera() {
            videoStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 500 },
                    height: { ideal: 685 },
                    aspectRatio: 500 / 685
                }
            });
            video.srcObject = videoStream;
            video.play();
            requestAnimationFrame(processFrame);
        }

        async function processFrame() {
            if (video.paused || video.ended) return;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frameData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            // ターゲット画像のヒストグラムを取得
            const targetHist = await calculateHistogram(targetImage);

            // 現在のフレームのヒストグラムを取得
            const frameHist = calculateHistogramFromImageData(frameData);

            // ヒストグラムの一致率を計算
            const matchRate = compareHistograms(frameHist, targetHist);
            document.getElementById("message").textContent = `一致率: ${(matchRate * 100).toFixed(2)}%`;

            requestAnimationFrame(processFrame);
        }

        async function calculateHistogram(image) {
            await new Promise(resolve => {
                image.onload = resolve;
            });
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.drawImage(image, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            return calculateHistogramFromImageData(imageData);
        }

        function calculateHistogramFromImageData(imageData) {
            const src = cv.matFromImageData(imageData);
            const hsv = new cv.Mat();
            cv.cvtColor(src, hsv, cv.COLOR_RGBA2HSV);

            // ヒストグラムの計算 (Hue チャンネルを使用)
            const histSize = [50]; // ビンの数
            const ranges = [0, 180]; // Hueの範囲
            const channels = [0]; // Hue チャンネルのみ使用

            const hist = new cv.Mat();
            cv.calcHist(hsv, channels, new cv.Mat(), hist, histSize, ranges);

            cv.normalize(hist, hist, 0, 1, cv.NORM_MINMAX);
            src.delete();
            hsv.delete();
            return hist;
        }

        function compareHistograms(hist1, hist2) {
            // ヒストグラムの比較 (コサイン類似度)
            const score = cv.compareHist(hist1, hist2, cv.HISTCMP_CORREL);
            return score;
        }
    </script>
</body>
</html>
