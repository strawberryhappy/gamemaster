<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>特徴点マッチング</title>
    <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
</head>
<body>
    <h1>カメラ映像と画像の特徴点マッチング</h1>
    <video id="video" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>
    
    <!-- 結果表示用の要素 -->
    <div id="matchRatio">一致割合: 0%</div>

    <script>
        // 特徴点の抽出を行うメイン関数
        async function main() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const matchRatioElement = document.getElementById('matchRatio');
            
            // 比較画像の特徴点を抽出する関数
            function extractFeaturesFromImage(imagePath, callback) {
                const img = new Image();
                img.src = imagePath;
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    const src = cv.imread(canvas);
                    const gray = new cv.Mat();
                    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

                    const orb = new cv.ORB();
                    const keypoints = new cv.KeyPointVector();
                    const descriptors = new cv.Mat();
                    orb.detectAndCompute(gray, new cv.Mat(), keypoints, descriptors);

                    callback({ keypoints, descriptors });

                    src.delete();
                    gray.delete();
                    orb.delete();
                };
            }

            // カメラフレームの特徴点を抽出し、比較画像の特徴点とマッチング
            function matchFeaturesWithCameraFrame(referenceDescriptors) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const src = cv.imread(canvas);
                const gray = new cv.Mat();
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

                const orb = new cv.ORB();
                const keypoints = new cv.KeyPointVector();
                const descriptors = new cv.Mat();
                orb.detectAndCompute(gray, new cv.Mat(), keypoints, descriptors);

                if (!descriptors.empty() && !referenceDescriptors.empty()) {
                    const bf = new cv.BFMatcher(cv.NORM_HAMMING, true);
                    const matches = new cv.DMatchVector();
                    bf.match(descriptors, referenceDescriptors, matches);

                    const totalKeypoints = keypoints.size();
                    const matchedKeypoints = matches.size();
                    const matchRatio = (matchedKeypoints / totalKeypoints) * 100;

                    // 一致割合を表示
                    matchRatioElement.textContent = `一致割合: ${matchRatio.toFixed(2)}%`;

                    matches.delete();
                    bf.delete();
                } else {
                    console.log("特徴点が検出されませんでした。");
                }

                src.delete();
                gray.delete();
                orb.delete();
                keypoints.delete();
                descriptors.delete();
            }

            // 比較対象の画像の特徴点を事前に抽出
            extractFeaturesFromImage("citizen.png", reference => {
                // カメラ映像を取得し、フレーム準備ができたら特徴点の比較を行う
                navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 500 },
                        height: { ideal: 685 },
                        aspectRatio: 500 / 685
                    }
                }).then(stream => {
                    video.srcObject = stream;

                    video.onloadedmetadata = () => {
                        video.width = video.videoWidth;
                        video.height = video.videoHeight;
                        setInterval(() => matchFeaturesWithCameraFrame(reference.descriptors), 1000); // 1秒ごとにマッチングを行う
                    };
                }).catch(err => {
                    console.error("カメラの起動に失敗しました: " + err);
                });
            });
        }

        // OpenCV.js のロード完了後にメイン関数を実行
        function onOpenCvReady() {
            if (cv.getBuildInformation) {
                main();
            } else {
                console.error("OpenCV.js のロードに失敗しました");
            }
        }
    </script>
</body>
</html>
