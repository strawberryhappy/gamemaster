<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ヒストグラム比較</title>
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
</head>
<body>
    <div id="message">一致率: - %</div>
    <video id="video" width="500" height="685" autoplay></video>
    <canvas id="canvas" width="500" height="685" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const targetImage = new Image();
        targetImage.crossOrigin = "Anonymous";
        targetImage.src = 'citizen.png'; // 比較画像のパスを指定

        let videoStream;

        // OpenCV.jsが読み込まれたらカメラ開始
        function onOpenCvReady() {
            console.log("OpenCV.js is ready.");
            startCamera();
        }

        // カメラ映像の取得とフレーム処理
        async function startCamera() {
            videoStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 500 },
                    height: { ideal: 685 },
                    aspectRatio: 500 / 685
                }
            });
            video.srcObject = videoStream;
            video.play();

            // targetImageがロードされてからフレーム処理を開始
            targetImage.onload = () => {
                console.log("Target image loaded.");
                requestAnimationFrame(processFrame);
            };
        }

        async function processFrame() {
            if (video.paused || video.ended) return;

            // フレームを描画してヒストグラムを取得
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frameData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const videoHist = calculateHistogramFromImageData(frameData);

            const targetHist = await calculateHistogram(targetImage);
            if (targetHist === null) {
                console.error("Failed to calculate histogram for the target image.");
                return;
            }

            // ヒストグラムの類似度を比較
            const similarity = compareHistograms(videoHist, targetHist);
            document.getElementById("message").textContent = `一致率: ${(similarity * 100).toFixed(2)}%`;

            requestAnimationFrame(processFrame);
        }

        // 画像データからヒストグラムを計算
        function calculateHistogramFromImageData(imageData) {
            const src = cv.matFromImageData(imageData);
            const hsv = new cv.Mat();
            cv.cvtColor(src, hsv, cv.COLOR_RGBA2HSV);

            const histSize = [50];
            const ranges = [0, 180];
            const channels = [0];

            const hist = new cv.Mat();
            cv.calcHist(hsv, channels, new cv.Mat(), hist, histSize, ranges);
            cv.normalize(hist, hist, 0, 1, cv.NORM_MINMAX);

            src.delete();
            hsv.delete();
            return hist;
        }

        async function calculateHistogram(image) {
            await new Promise(resolve => {
                image.onload = resolve;
            });
            const canvas = document.createElement('canvas');
            canvas.width = image.width;
            canvas.height = image.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(image, 0, 0);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            return calculateHistogramFromImageData(imageData);
        }

        // ヒストグラムの類似度を比較
        function compareHistograms(hist1, hist2) {
            return cv.compareHist(hist1, hist2, cv.HISTCMP_CORREL);
        }
    </script>
</body>
</html>
